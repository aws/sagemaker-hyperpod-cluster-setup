{"Description":"HyperPod Cluster Stack","Parameters":{"ResourceNamePrefix":{"Type":"String","Default":"sagemaker-hyperpod-eks","Description":"Prefix to be used for all resources created by this template."},"HelmChartStatus":{"Type":"String","Default":"HelmChartNotRequired","Description":"Conditionally wait on HelmChartStack if deployed"},"HyperPodClusterName":{"Type":"String","Default":"ml-cluster","Description":"Name of SageMaker HyperPod Cluster."},"NodeRecovery":{"Type":"String","Default":"Automatic","AllowedValues":["Automatic","None"],"Description":"Enable or disable the automatic node recovery feature"},"EKSClusterName":{"Type":"String","Default":"hyperpod-eks-cluster","Description":"The name of the EKS cluster you wish to use."},"SecurityGroupIds":{"Type":"String"},"PrivateSubnetIds":{"Type":"String","Description":"Comma-separated list of private subnet IDs"},"CustomResourceS3Bucket":{"Type":"String","Default":"ws-assets-prod-iad-r-pdx-f3b3f9f1a7d6a3d0","Description":"The name of the S3 bucket containing the custom resource."},"SageMakerIAMRoleName":{"Type":"String","Default":"sagemaker-hyperpod-eks-role","Description":"The name of the IAM role that SageMaker will use to access the AWS resources on your behalf."},"S3BucketName":{"Type":"String","Default":"sagemaker-hyperpod-eks-bucket","Description":"The name of the S3 bucket used to store the cluster lifecycle scripts."},"OnCreatePath":{"Type":"String","Default":"sagemaker-hyperpod-eks-bucket","Description":"The file name of lifecycle script for the general purpose instance group. This script runs during cluster creation."},"InstanceGroupSettings1":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings2":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings3":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings4":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings5":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings6":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings7":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings8":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings9":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings10":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings11":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings12":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings13":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings14":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings15":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings16":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings17":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings18":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings19":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings20":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."}},"Resources":{"HyperPodClusterCustomResourceRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"},"Action":"sts:AssumeRole"}]},"ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["sagemaker:CreateCluster","sagemaker:DeleteCluster","sagemaker:DescribeCluster"],"Resource":"*"},{"Effect":"Allow","Action":["eks:DescribeCluster","ec2:DescribeSecurityGroups","ec2:DescribeSubnets","ec2:DescribeVpcs","iam:CreateServiceLinkedRole","iam:PassRole"],"Resource":"*"}]},"PolicyName":"HyperPodClusterCreationPolicy"}]}},"hyperPodCustomResourceFunction":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Ref":"CustomResourceS3Bucket"},"S3Key":"resources/artifacts/hp-lambda-function.zip"},"Environment":{"Variables":{"HYPER_POD_CLUSTER_NAME":{"Ref":"HyperPodClusterName"},"NODE_RECOVERY":{"Ref":"NodeRecovery"},"EKS_CLUSTER_ARN":{"Fn::Sub":"arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}"},"SECURITY_GROUP_IDS":{"Ref":"SecurityGroupIds"},"PRIVATE_SUBNET_IDS":{"Ref":"PrivateSubnetIds"},"SAGEMAKER_IAM_ROLE_NAME":{"Ref":"SageMakerIAMRoleName"},"S3_BUCKET_NAME":{"Ref":"S3BucketName"},"ON_CREATE_PATH":{"Ref":"OnCreatePath"},"INSTANCE_GROUP_SETTINGS1":{"Ref":"InstanceGroupSettings1"},"INSTANCE_GROUP_SETTINGS2":{"Ref":"InstanceGroupSettings2"},"INSTANCE_GROUP_SETTINGS3":{"Ref":"InstanceGroupSettings3"},"INSTANCE_GROUP_SETTINGS4":{"Ref":"InstanceGroupSettings4"},"INSTANCE_GROUP_SETTINGS5":{"Ref":"InstanceGroupSettings5"},"INSTANCE_GROUP_SETTINGS6":{"Ref":"InstanceGroupSettings6"},"INSTANCE_GROUP_SETTINGS7":{"Ref":"InstanceGroupSettings7"},"INSTANCE_GROUP_SETTINGS8":{"Ref":"InstanceGroupSettings8"},"INSTANCE_GROUP_SETTINGS9":{"Ref":"InstanceGroupSettings9"},"INSTANCE_GROUP_SETTINGS10":{"Ref":"InstanceGroupSettings10"},"INSTANCE_GROUP_SETTINGS11":{"Ref":"InstanceGroupSettings11"},"INSTANCE_GROUP_SETTINGS12":{"Ref":"InstanceGroupSettings12"},"INSTANCE_GROUP_SETTINGS13":{"Ref":"InstanceGroupSettings13"},"INSTANCE_GROUP_SETTINGS14":{"Ref":"InstanceGroupSettings14"},"INSTANCE_GROUP_SETTINGS15":{"Ref":"InstanceGroupSettings15"},"INSTANCE_GROUP_SETTINGS16":{"Ref":"InstanceGroupSettings16"},"INSTANCE_GROUP_SETTINGS17":{"Ref":"InstanceGroupSettings17"},"INSTANCE_GROUP_SETTINGS18":{"Ref":"InstanceGroupSettings18"},"INSTANCE_GROUP_SETTINGS19":{"Ref":"InstanceGroupSettings19"},"INSTANCE_GROUP_SETTINGS20":{"Ref":"InstanceGroupSettings20"},"NUMBER_OF_INSTANCE_GROUPS":"20"}},"FunctionName":{"Fn::Sub":["${ResourceNamePrefix}-hyperpod-cluster-creator",{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"}}]},"Handler":"lambda_function.lambda_handler","Role":{"Fn::GetAtt":["HyperPodClusterCustomResourceRole","Arn"]},"Runtime":"python3.12","Timeout":600}},"HpLambdaCustomResource":{"Type":"AWS::CloudFormation::CustomResource","Properties":{"ServiceToken":{"Fn::GetAtt":["hyperPodCustomResourceFunction","Arn"]}}}}}