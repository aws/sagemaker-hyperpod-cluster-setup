{"Description":"Fsx Stack","Parameters":{"ResourceNamePrefix":{"Type":"String","Default":"sagemaker-hyperpod-eks","Description":"Prefix to be used for all resources created by this template."},"EKSClusterName":{"Type":"String","Default":"hyperpod-eks-cluster","Description":"The name of the EKS cluster you wish to use."},"CustomResourceS3Bucket":{"Type":"String","Default":"aws-sagemaker-hyperpod-cluster-setup-us-west-2-prod","Description":"The name of the S3 bucket containing the custom resource."},"LayerS3Key":{"Type":"String","Default":"resources/artifacts/helm-lambda-layer.zip","Description":"The S3 key for the lambda layer zip file."},"FunctionS3Key":{"Type":"String","Default":"resources/artifacts/fsx-lambda-function.zip","Description":"The S3 key for the lambda function zip file."},"PrivateSubnetId":{"Type":"String","Description":"Comma-separated list of private subnet IDs"},"SecurityGroupIds":{"Type":"String","Description":"ID of the security group to use"},"PerUnitStorageThroughput":{"Type":"Number","Default":250,"Description":"Per unit storage throughput for the FSx file system"},"DataCompressionType":{"Type":"String","Default":"NONE","AllowedValues":["NONE","LZ4"],"Description":"Data compression type for the FSx file system (NONE, LZ4)"},"FileSystemTypeVersion":{"Type":"Number","Default":2.12,"Description":"File system type version for the FSx file system"},"StorageCapacity":{"Type":"Number","Default":1200,"Description":"Storage capacity for the FSx file system in GiB"},"FsxFileSystemId":{"Type":"String","Default":"","Description":"Existing FSx for Lustre file system"}},"Resources":{"FsxCustomResourceRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["eks:DescribeCluster","eks:TagResource"],"Resource":{"Fn::Sub":"arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}"}}]},"PolicyName":{"Fn::Sub":"${ResourceNamePrefix}-EKSClusterAccess-${AWS::Region}"}},{"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["iam:GetOpenIDConnectProvider","iam:CreateOpenIDConnectProvider","iam:TagOpenIDConnectProvider"],"Resource":{"Fn::Sub":"arn:aws:iam::${AWS::AccountId}:oidc-provider/*"}},{"Effect":"Allow","Action":["iam:GetRole","iam:DetachRolePolicy","iam:CreateRole","iam:DeleteRole","iam:TagRole","iam:AttachRolePolicy"],"Resource":{"Fn::Sub":"arn:aws:iam::${AWS::AccountId}:role/*"}}]},"PolicyName":{"Fn::Sub":"${ResourceNamePrefix}-IAMAccess-${AWS::Region}"}},{"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["cloudformation:ListStacks","cloudformation:CreateStack"],"Resource":"*"}]},"PolicyName":{"Fn::Sub":"${ResourceNamePrefix}-CloudFormationAccess-${AWS::Region}"}}]}},"FsxCustomResourceAccessEntry":{"Type":"AWS::EKS::AccessEntry","Properties":{"AccessPolicies":[{"AccessScope":{"Type":"cluster"},"PolicyArn":"arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy"}],"ClusterName":{"Ref":"EKSClusterName"},"PrincipalArn":{"Fn::GetAtt":["FsxCustomResourceRole","Arn"]}}},"HelmCustomResourceLayer":{"Type":"AWS::Lambda::LayerVersion","Properties":{"CompatibleArchitectures":["x86_64"],"CompatibleRuntimes":["python3.9","python3.10","python3.11","python3.12"],"Content":{"S3Bucket":{"Ref":"CustomResourceS3Bucket"},"S3Key":{"Ref":"LayerS3Key"}},"Description":"Lambda Layer for kubectl, helm, and git tools","LayerName":{"Fn::Sub":"${ResourceNamePrefix}-helm-chart-installer-helm-lambda-layer"}}},"HelmCustomResourceFunction":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Ref":"CustomResourceS3Bucket"},"S3Key":{"Ref":"FunctionS3Key"}},"Environment":{"Variables":{"CLUSTER_NAME":{"Ref":"EKSClusterName"},"PATH":"/opt/python/bin:/var/lang/bin:/usr/local/bin:/usr/bin/:/bin","GIT_EXEC_PATH":"/opt/python/libexec/git-core","KUBECONFIG":"/tmp/.kube/config","CREATE_FSX":"true","LD_LIBRARY_PATH":"/opt/python/lib"}},"FunctionName":{"Fn::Sub":"${ResourceNamePrefix}-helm-chart-installer"},"Handler":"lambda_function.lambda_handler","Layers":[{"Ref":"HelmCustomResourceLayer"}],"Role":{"Fn::GetAtt":["FsxCustomResourceRole","Arn"]},"Runtime":"python3.12","Timeout":600},"DependsOn":["FsxCustomResourceAccessEntry"]},"HelmCustomResource":{"Type":"AWS::CloudFormation::CustomResource","Properties":{"ServiceToken":{"Fn::GetAtt":["HelmCustomResourceFunction","Arn"]}}},"FsxCustomResourceLayer":{"Type":"AWS::Lambda::LayerVersion","Properties":{"CompatibleArchitectures":["x86_64"],"CompatibleRuntimes":["python3.9","python3.10","python3.11","python3.12"],"Content":{"S3Bucket":{"Ref":"CustomResourceS3Bucket"},"S3Key":{"Ref":"LayerS3Key"}},"Description":"Lambda Layer for kubectl, helm, and git tools","LayerName":{"Fn::Sub":"${ResourceNamePrefix}-fsx-lambda-layer"}}},"FsxCustomResourceFunction":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Ref":"CustomResourceS3Bucket"},"S3Key":{"Ref":"FunctionS3Key"}},"Environment":{"Variables":{"CLUSTER_NAME":{"Ref":"EKSClusterName"},"PRIVATE_SUBNET_ID":{"Ref":"PrivateSubnetId"},"SECURITY_GROUP_ID":{"Ref":"SecurityGroupIds"},"PER_UNIT_STORAGE_THROUGHPUT":{"Ref":"PerUnitStorageThroughput"},"DATA_COMPRESSION_TYPE":{"Ref":"DataCompressionType"},"FILE_SYSTEM_TYPE_VERSION":{"Ref":"FileSystemTypeVersion"},"STORAGE_CAPACITY":{"Ref":"StorageCapacity"},"FSX_FILE_SYSTEM_ID":{"Ref":"FsxFileSystemId"},"PATH":"/opt/python/bin:/var/lang/bin:/usr/local/bin:/usr/bin/:/bin","GIT_EXEC_PATH":"/opt/python/libexec/git-core","KUBECONFIG":"/tmp/.kube/config","LD_LIBRARY_PATH":"/opt/python/lib"}},"FunctionName":{"Fn::Sub":"${ResourceNamePrefix}-fsx-installer"},"Handler":"lambda_function.lambda_handler","Layers":[{"Ref":"FsxCustomResourceLayer"}],"Role":{"Fn::GetAtt":["FsxCustomResourceRole","Arn"]},"Runtime":"python3.12","Timeout":600},"DependsOn":["FsxCustomResourceAccessEntry","HelmCustomResource"]},"FsxCustomResource":{"Type":"AWS::CloudFormation::CustomResource","Properties":{"ServiceToken":{"Fn::GetAtt":["FsxCustomResourceFunction","Arn"]}}}},"Outputs":{"FsxDeploymentComplete":{"Description":"Indicates fsx deployment is complete","Value":"FsxDeploymentComplete"}}}