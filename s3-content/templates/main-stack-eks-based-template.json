{"Description":"Main Stack for EKS based HyperPod Cluster","Parameters":{"Stage":{"Type":"String","Default":"prod","AllowedValues":["gamma","prod"],"Description":"Deployment stage (gamma, prod)"},"ResourceNamePrefix":{"Type":"String","Default":"sagemaker-hyperpod-eks","Description":"Prefix to be used for all resources created by this template."},"VpcCIDR":{"Type":"String","Default":"10.192.0.0/16","Description":"The IP range (CIDR notation) for the VPC."},"AvailabilityZoneIds":{"Type":"CommaDelimitedList","Default":"us-east-2a,us-east-2b,,,","Description":"List of AZs to deploy subnets in (up to 5, comma separated)"},"VpcId":{"Type":"String","Default":"vpc-1234567890abcdef0","Description":"The ID of the VPC you wish to use if you do not want to create a new VPC."},"NatGatewayIds":{"Type":"CommaDelimitedList","Default":"nat-1234567890abcdef0","Description":"Comma-separated list of NAT Gateway IDs to route internet bound traffic to from the newly created private subnets."},"SecurityGroupId":{"Type":"String","Default":"","Description":"The ID of the security group associated with an existing EKS cluster."},"KubernetesVersion":{"Type":"String","Default":"1.31","Description":"The Kubernetes version to use for the EKS cluster."},"EKSClusterName":{"Type":"String","Default":"sagemaker-hyperpod-eks-cluster","Description":"The name of the newly created of preexisting EKS cluster you wish to use."},"EksPrivateSubnetIds":{"Type":"CommaDelimitedList","Default":"subnet-1234567890abcdef0,subnet-1234567890abcdef0","Description":"Comma-delimited list of private subnet IDs for the EKS cluster"},"SecurityGroupIds":{"Type":"CommaDelimitedList","Default":"sg-1234567890abcdef0","Description":"The Id of your cluster security group."},"PrivateRouteTableIds":{"Type":"CommaDelimitedList","Default":"rtb-1234567890abcdef0","Description":"Comma-separated list of private route table IDs."},"S3BucketName":{"Type":"String","Default":"sagemaker-hyperpod-eks-bucket","Description":"The name of the S3 bucket used to store the cluster lifecycle scripts."},"GithubRawUrl":{"Type":"String","Default":"https://raw.githubusercontent.com/aws-samples/awsome-distributed-training/refs/heads/main/1.architectures/7.sagemaker-hyperpod-eks/LifecycleScripts/base-config/on_create.sh","Description":"The raw GitHub URL for the lifecycle script."},"HelmRepoUrl":{"Type":"String","Default":"https://github.com/aws/sagemaker-hyperpod-cli.git","Description":"The URL of the Helm repo containing the HyperPod Helm chart."},"HelmRepoPath":{"Type":"String","Default":"helm_chart/HyperPodHelmChart","Description":"The path to the HyperPod Helm chart in the Helm repo."},"HelmOperators":{"Type":"String","Default":"","Description":"The configuration of HyperPod Helm chart"},"Namespace":{"Type":"String","Default":"kube-system","Description":"The namespace to deploy the HyperPod Helm chart into."},"HelmRelease":{"Type":"String","Default":"hyperpod-dependencies","Description":"The name of the Helm release."},"HyperPodClusterName":{"Type":"String","Default":"ml-cluster","Description":"Name of SageMaker HyperPod Cluster."},"NodeRecovery":{"Type":"String","Default":"Automatic","AllowedValues":["Automatic","None"],"Description":"Specifies whether to enable or disable the automatic node recovery feature (Automatic or None)."},"SageMakerIAMRoleName":{"Type":"String","Default":"sagemaker-hyperpod-eks-role","Description":"The name of the IAM role that SageMaker will use to access the AWS resources on your behalf."},"PrivateSubnetIds":{"Type":"CommaDelimitedList","Default":"subnet-1234567890abcdef0,subnet-1234567890abcdef0","Description":"Comma-separated list of private subnet IDs for EKS cluster."},"OnCreatePath":{"Type":"String","Default":"sagemaker-hyperpod-eks-bucket","Description":"The file name of lifecycle script for the general purpose instance group. This script runs during cluster creation."},"InstanceGroupSettings1":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings2":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings3":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings4":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings5":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings6":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings7":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings8":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings9":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings10":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings11":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings12":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings13":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings14":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings15":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings16":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings17":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings18":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings19":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"InstanceGroupSettings20":{"Type":"String","Default":"[]","Description":"JSON array string containing instance group configurations."},"FsxSubnetId":{"Type":"String","Default":"","Description":"The subnet id that will be used to create FSx"},"FsxAvailabilityZone":{"Type":"String","Default":"","Description":"The availability zone to get subnet id that will be used to create FSx"},"PerUnitStorageThroughput":{"Type":"Number","Default":250,"Description":"Per unit storage throughput for the FSx file system"},"DataCompressionType":{"Type":"String","Default":"NONE","AllowedValues":["NONE","LZ4"],"Description":"Data compression type for the FSx file system (NONE, LZ4)"},"FileSystemTypeVersion":{"Type":"Number","Default":2.12,"Description":"File system type version for the FSx file system"},"StorageCapacity":{"Type":"Number","Default":1200,"Description":"Storage capacity for the FSx file system in GiB"},"FsxFileSystemId":{"Type":"String","Default":"","Description":"Existing FSx for Lustre file system"},"CreateVPCStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create VPC Stack"},"CreatePrivateSubnetStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create Private Subnet Stack"},"CreateSecurityGroupStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create Security Group Stack"},"CreateEKSClusterStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create EKS Cluster Stack"},"CreateS3BucketStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create S3 Bucket Stack"},"CreateS3EndpointStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create S3 Endpoint Stack"},"CreateLifeCycleScriptStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create Life Cycle Script Stack"},"CreateSageMakerIAMRoleStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create SageMaker IAM Role Stack"},"CreateHelmChartStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create Helm Chart Stack"},"CreateHyperPodClusterStack":{"Type":"String","Default":"true","AllowedValues":["true","false"],"Description":"Boolean to Create HyperPod Cluster Stack"},"CreateFsxStack":{"Type":"String","Default":"false","AllowedValues":["true","false"],"Description":"Boolean to Create HyperPod Cluster Stack"}},"Conditions":{"CreateVPCStackCondition":{"Fn::Equals":[{"Ref":"CreateVPCStack"},"true"]},"CreatePrivateSubnetStackCondition":{"Fn::Equals":[{"Ref":"CreatePrivateSubnetStack"},"true"]},"CreateSecurityGroupStackCondition":{"Fn::Equals":[{"Ref":"CreateSecurityGroupStack"},"true"]},"CreateEKSClusterStackCondition":{"Fn::Equals":[{"Ref":"CreateEKSClusterStack"},"true"]},"CreateS3BucketStackCondition":{"Fn::Equals":[{"Ref":"CreateS3BucketStack"},"true"]},"CreateS3EndpointStackCondition":{"Fn::Equals":[{"Ref":"CreateS3EndpointStack"},"true"]},"CreateLifeCycleScriptStackCondition":{"Fn::Equals":[{"Ref":"CreateLifeCycleScriptStack"},"true"]},"CreateSageMakerIAMRoleStackCondition":{"Fn::Equals":[{"Ref":"CreateSageMakerIAMRoleStack"},"true"]},"CreateHelmChartStackCondition":{"Fn::Equals":[{"Ref":"CreateHelmChartStack"},"true"]},"CreateHyperPodClusterStackCondition":{"Fn::And":[{"Fn::Equals":[{"Ref":"CreateHyperPodClusterStack"},"true"]},{"Fn::Not":[{"Fn::And":[{"Fn::Equals":[{"Ref":"CreateEKSClusterStack"},"true"]},{"Fn::Equals":[{"Ref":"CreateHelmChartStack"},"false"]}]}]}]},"CreateFsxStackCondition":{"Fn::Equals":[{"Ref":"CreateFsxStack"},"true"]}},"Resources":{"VPCStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/vpc-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"VpcCIDR":{"Ref":"VpcCIDR"},"AvailabilityZoneIds":{"Fn::Join":[",",{"Ref":"AvailabilityZoneIds"}]}}},"Condition":"CreateVPCStackCondition"},"PrivateSubnetStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/private-subnet-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"VpcId":{"Fn::If":["CreateVPCStackCondition",{"Fn::GetAtt":["VPCStack","Outputs.VpcId"]},{"Ref":"VpcId"}]},"VpcCidrBlock":{"Ref":"VpcCIDR"},"AvailabilityZoneIds":{"Fn::Join":[",",{"Ref":"AvailabilityZoneIds"}]},"NatGatewayIds":{"Fn::If":["CreateVPCStackCondition",{"Fn::GetAtt":["VPCStack","Outputs.NatGatewayIds"]},{"Fn::Join":[",",{"Ref":"NatGatewayIds"}]}]}}},"Condition":"CreatePrivateSubnetStackCondition"},"SecurityGroupStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/security-group-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"VpcId":{"Fn::If":["CreateVPCStackCondition",{"Fn::GetAtt":["VPCStack","Outputs.VpcId"]},{"Ref":"VpcId"}]},"SecurityGroupId":{"Ref":"SecurityGroupId"}}},"Condition":"CreateSecurityGroupStackCondition"},"EKSClusterStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/eks-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"VpcId":{"Fn::If":["CreateVPCStackCondition",{"Fn::GetAtt":["VPCStack","Outputs.VpcId"]},{"Ref":"VpcId"}]},"KubernetesVersion":{"Ref":"KubernetesVersion"},"EKSClusterName":{"Ref":"EKSClusterName"},"EksPrivateSubnetIds":{"Fn::If":["CreatePrivateSubnetStackCondition",{"Fn::GetAtt":["PrivateSubnetStack","Outputs.EksPrivateSubnetIds"]},{"Fn::Join":[",",{"Ref":"PrivateSubnetIds"}]}]},"SecurityGroupIds":{"Fn::If":["CreateSecurityGroupStackCondition",{"Fn::GetAtt":["SecurityGroupStack","Outputs.SecurityGroupId"]},{"Fn::Join":[",",{"Ref":"SecurityGroupIds"}]}]}}},"Condition":"CreateEKSClusterStackCondition"},"S3BucketStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/s3-bucket-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"}}},"Condition":"CreateS3BucketStackCondition"},"S3EndpointStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/s3-endpoint-template.json"},"Parameters":{"VpcId":{"Fn::If":["CreateVPCStackCondition",{"Fn::GetAtt":["VPCStack","Outputs.VpcId"]},{"Ref":"VpcId"}]},"PrivateRouteTableIds":{"Fn::If":["CreatePrivateSubnetStackCondition",{"Fn::GetAtt":["PrivateSubnetStack","Outputs.PrivateRouteTableIds"]},{"Fn::Join":[",",{"Ref":"PrivateRouteTableIds"}]}]}}},"Condition":"CreateS3EndpointStackCondition"},"LifeCycleScriptStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/lifecycle-script-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"S3BucketName":{"Fn::If":["CreateS3BucketStackCondition",{"Fn::GetAtt":["S3BucketStack","Outputs.S3BucketName"]},{"Ref":"S3BucketName"}]}}},"Condition":"CreateLifeCycleScriptStackCondition"},"SageMakerIAMRoleStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/sagemaker-iam-role-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"S3BucketName":{"Fn::If":["CreateS3BucketStackCondition",{"Fn::GetAtt":["S3BucketStack","Outputs.S3BucketName"]},{"Ref":"S3BucketName"}]}}},"Condition":"CreateSageMakerIAMRoleStackCondition"},"HelmChartStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/helm-chart-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"HelmRepoUrl":{"Ref":"HelmRepoUrl"},"HelmRepoPath":{"Ref":"HelmRepoPath"},"Namespace":{"Ref":"Namespace"},"HelmRelease":{"Ref":"HelmRelease"},"HelmOperators":{"Ref":"HelmOperators"},"CustomResourceS3Bucket":{"Fn::Sub":"aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}"},"EKSClusterName":{"Fn::If":["CreateEKSClusterStackCondition",{"Fn::GetAtt":["EKSClusterStack","Outputs.EKSClusterName"]},{"Ref":"EKSClusterName"}]}}},"Condition":"CreateHelmChartStackCondition"},"HyperPodClusterStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/hyperpod-cluster-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"HelmChartStatus":{"Fn::If":["CreateHelmChartStackCondition",{"Fn::GetAtt":["HelmChartStack","Outputs.HelmChartDeploymentComplete"]},"HelmChartNotRequired"]},"HyperPodClusterName":{"Ref":"HyperPodClusterName"},"NodeRecovery":{"Ref":"NodeRecovery"},"EKSClusterName":{"Fn::If":["CreateEKSClusterStackCondition",{"Fn::GetAtt":["EKSClusterStack","Outputs.EKSClusterName"]},{"Ref":"EKSClusterName"}]},"SecurityGroupIds":{"Fn::If":["CreateSecurityGroupStackCondition",{"Fn::GetAtt":["SecurityGroupStack","Outputs.SecurityGroupId"]},{"Fn::Join":[",",{"Ref":"SecurityGroupIds"}]}]},"PrivateSubnetIds":{"Fn::If":["CreatePrivateSubnetStackCondition",{"Fn::GetAtt":["PrivateSubnetStack","Outputs.PrivateSubnetIds"]},{"Fn::Join":[",",{"Ref":"PrivateSubnetIds"}]}]},"CustomResourceS3Bucket":{"Fn::Sub":"aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}"},"SageMakerIAMRoleName":{"Fn::If":["CreateSageMakerIAMRoleStackCondition",{"Fn::GetAtt":["SageMakerIAMRoleStack","Outputs.SageMakerIAMRoleName"]},{"Ref":"SageMakerIAMRoleName"}]},"S3BucketName":{"Fn::If":["CreateS3BucketStackCondition",{"Fn::GetAtt":["S3BucketStack","Outputs.S3BucketName"]},{"Ref":"S3BucketName"}]},"OnCreatePath":{"Fn::If":["CreateS3BucketStackCondition","on_create.sh",{"Ref":"OnCreatePath"}]}}},"Condition":"CreateHyperPodClusterStackCondition"},"FsxStack":{"Type":"AWS::CloudFormation::Stack","Properties":{"TemplateURL":{"Fn::Sub":"https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/fsx-template.json"},"Parameters":{"ResourceNamePrefix":{"Ref":"ResourceNamePrefix"},"EKSClusterName":{"Fn::If":["CreateEKSClusterStackCondition",{"Fn::GetAtt":["EKSClusterStack","Outputs.EKSClusterName"]},{"Ref":"EKSClusterName"}]},"CustomResourceS3Bucket":{"Fn::Sub":"aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}"},"PrivateSubnetIds":{"Fn::If":["CreatePrivateSubnetStackCondition",{"Fn::GetAtt":["PrivateSubnetStack","Outputs.PrivateSubnetIds"]},{"Fn::Join":[",",{"Ref":"PrivateSubnetIds"}]}]},"FsxSubnetId":{"Ref":"FsxSubnetId"},"FsxAvailabilityZone":{"Ref":"FsxAvailabilityZone"},"SecurityGroupIds":{"Fn::If":["CreateSecurityGroupStackCondition",{"Fn::GetAtt":["SecurityGroupStack","Outputs.SecurityGroupId"]},{"Fn::Join":[",",{"Ref":"SecurityGroupIds"}]}]},"PerUnitStorageThroughput":{"Ref":"PerUnitStorageThroughput"},"DataCompressionType":{"Ref":"DataCompressionType"},"FileSystemTypeVersion":{"Ref":"FileSystemTypeVersion"},"StorageCapacity":{"Ref":"StorageCapacity"},"FsxFileSystemId":{"Ref":"FsxFileSystemId"}}},"Condition":"CreateFsxStackCondition"}},"Outputs":{"OutputVpcId":{"Value":{"Fn::GetAtt":["VPCStack","Outputs.VpcId"]},"Condition":"CreateVPCStackCondition"},"OutputPrivateSubnetIds":{"Value":{"Fn::GetAtt":["PrivateSubnetStack","Outputs.PrivateSubnetIds"]},"Condition":"CreatePrivateSubnetStackCondition"},"OutputSecurityGroupId":{"Value":{"Fn::GetAtt":["SecurityGroupStack","Outputs.SecurityGroupId"]},"Condition":"CreateSecurityGroupStackCondition"},"OutputEKSClusterArn":{"Value":{"Fn::GetAtt":["EKSClusterStack","Outputs.EKSClusterArn"]},"Condition":"CreateEKSClusterStackCondition"},"OutputEKSClusterName":{"Value":{"Fn::GetAtt":["EKSClusterStack","Outputs.EKSClusterName"]},"Condition":"CreateEKSClusterStackCondition"},"OutputSageMakerIAMRoleArn":{"Value":{"Fn::GetAtt":["SageMakerIAMRoleStack","Outputs.SageMakerIAMRoleArn"]},"Condition":"CreateSageMakerIAMRoleStackCondition"},"OutputS3BucketName":{"Value":{"Fn::GetAtt":["S3BucketStack","Outputs.S3BucketName"]},"Condition":"CreateS3BucketStackCondition"},"OutputHyperPodClusterName":{"Value":{"Fn::GetAtt":["HyperPodClusterStack","Outputs.HyperPodClusterName"]},"Condition":"CreateHyperPodClusterStackCondition"},"OutputHyperPodClusterArn":{"Value":{"Fn::GetAtt":["HyperPodClusterStack","Outputs.HyperPodClusterArn"]},"Condition":"CreateHyperPodClusterStackCondition"}}}