Description: VPC Stack
Parameters:
  ResourceNamePrefix:
    Type: String
    Default: sagemaker-hyperpod-eks
    Description: Prefix to be used for all resources created by this template.
  VpcCIDR:
    Type: String
    Default: 10.192.0.0/16
    Description: The IP range (CIDR notation) for the VPC.
  AvailabilityZoneIds:
    Type: CommaDelimitedList
    Default: use2-az2,,,,
    Description: List of AZs to deploy subnets in (up to 5)
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Ref: VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/VPC
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-IGW
    Metadata:
      aws:cdk:path: VpcCfnTemplate/InternetGateway
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/InternetGatewayAttachment
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-Public-Routes
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicRouteTable
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: PublicRouteTable
    DependsOn:
      - InternetGatewayAttachment
    Metadata:
      aws:cdk:path: VpcCfnTemplate/DefaultPublicRoute
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZoneId:
        Fn::Select:
          - 0
          - Ref: AvailabilityZoneIds
      CidrBlock:
        Fn::Join:
          - ''
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .
            - Fn::Select:
                - 1
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-Public-Subnet1
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet1
    Condition: HasAZ1
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    DependsOn:
      - InternetGatewayAttachment
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway1EIP
    Condition: HasAZ1
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - NatGateway1EIP
          - AllocationId
      SubnetId:
        Ref: PublicSubnet1
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway1
    Condition: HasAZ1
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublicSubnet1
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet1RouteTableAssociation
    Condition: HasAZ1
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZoneId:
        Fn::Select:
          - 1
          - Ref: AvailabilityZoneIds
      CidrBlock:
        Fn::Join:
          - ''
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .
            - Fn::Select:
                - 1
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .32.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-Public-Subnet2
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet2
    Condition: HasAZ2
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    DependsOn:
      - InternetGatewayAttachment
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway2EIP
    Condition: HasAZ2
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - NatGateway2EIP
          - AllocationId
      SubnetId:
        Ref: PublicSubnet2
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway2
    Condition: HasAZ2
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublicSubnet2
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet2RouteTableAssociation
    Condition: HasAZ2
  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZoneId:
        Fn::Select:
          - 2
          - Ref: AvailabilityZoneIds
      CidrBlock:
        Fn::Join:
          - ''
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .
            - Fn::Select:
                - 1
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .64.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-Public-Subnet3
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet3
    Condition: HasAZ3
  NatGateway3EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    DependsOn:
      - InternetGatewayAttachment
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway3EIP
    Condition: HasAZ3
  NatGateway3:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - NatGateway3EIP
          - AllocationId
      SubnetId:
        Ref: PublicSubnet3
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway3
    Condition: HasAZ3
  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublicSubnet3
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet3RouteTableAssociation
    Condition: HasAZ3
  PublicSubnet4:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZoneId:
        Fn::Select:
          - 3
          - Ref: AvailabilityZoneIds
      CidrBlock:
        Fn::Join:
          - ''
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .
            - Fn::Select:
                - 1
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .96.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-Public-Subnet4
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet4
    Condition: HasAZ4
  NatGateway4EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    DependsOn:
      - InternetGatewayAttachment
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway4EIP
    Condition: HasAZ4
  NatGateway4:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - NatGateway4EIP
          - AllocationId
      SubnetId:
        Ref: PublicSubnet4
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway4
    Condition: HasAZ4
  PublicSubnet4RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublicSubnet4
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet4RouteTableAssociation
    Condition: HasAZ4
  PublicSubnet5:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZoneId:
        Fn::Select:
          - 4
          - Ref: AvailabilityZoneIds
      CidrBlock:
        Fn::Join:
          - ''
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .
            - Fn::Select:
                - 1
                - Fn::Split:
                    - .
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - /
                            - Ref: VpcCIDR
            - .128.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-sagemaker-hyperpod-prerequiste
          Value:
            Fn::Sub: ${ResourceNamePrefix}-Public-Subnet5
      VpcId:
        Ref: VPC
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet5
    Condition: HasAZ5
  NatGateway5EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    DependsOn:
      - InternetGatewayAttachment
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway5EIP
    Condition: HasAZ5
  NatGateway5:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - NatGateway5EIP
          - AllocationId
      SubnetId:
        Ref: PublicSubnet5
    Metadata:
      aws:cdk:path: VpcCfnTemplate/NatGateway5
    Condition: HasAZ5
  PublicSubnet5RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublicSubnet5
    Metadata:
      aws:cdk:path: VpcCfnTemplate/PublicSubnet5RouteTableAssociation
    Condition: HasAZ5
Conditions:
  HasAZ1:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 0
              - Ref: AvailabilityZoneIds
          - ''
  HasAZ2:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 1
              - Ref: AvailabilityZoneIds
          - ''
  HasAZ3:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 2
              - Ref: AvailabilityZoneIds
          - ''
  HasAZ4:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 3
              - Ref: AvailabilityZoneIds
          - ''
  HasAZ5:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 4
              - Ref: AvailabilityZoneIds
          - ''
Outputs:
  VpcId:
    Description: VPC Id
    Value:
      Ref: VPC
  NatGatewayIds:
    Description: Comma-delimited list of created NAT Gateway IDs
    Value:
      Fn::Join:
        - ','
        - - Fn::If:
              - HasAZ1
              - Ref: NatGateway1
              - Ref: AWS::NoValue
          - Fn::If:
              - HasAZ2
              - Ref: NatGateway2
              - Ref: AWS::NoValue
          - Fn::If:
              - HasAZ3
              - Ref: NatGateway3
              - Ref: AWS::NoValue
          - Fn::If:
              - HasAZ4
              - Ref: NatGateway4
              - Ref: AWS::NoValue
          - Fn::If:
              - HasAZ5
              - Ref: NatGateway5
              - Ref: AWS::NoValue
